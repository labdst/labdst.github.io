<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Research Lifecycle Tracker – TKD ITS</title>
<style>
  :root{--bg:#f8fafc;--fg:#0f172a;--muted:#475569;--brand:#0ea5e9;--border:#e2e8f0}
  html,body{margin:0;background:var(--bg);color:var(--fg);font:16px/1.55 system-ui,-apple-system,Segoe UI,Arial}
  /* placeholder header so layout stabil sebelum header.html ter-load */
  #site-header{min-height:64px;background:#004080}
  .wrap{max-width:1100px;margin:24px auto 36px;padding:0 16px}
  h1{margin:0 0 8px;font-size:26px}
  .sub{color:var(--muted);margin:0 0 18px}
  .rlm{display:flex;flex-wrap:wrap;gap:10px;margin:8px 0 18px}
  .phase{padding:10px 14px;border:1px solid var(--border);border-radius:999px;background:#fff;cursor:pointer}
  .phase.active{background:var(--brand);border-color:var(--brand);color:#fff}
  .filters{display:flex;gap:10px;flex-wrap:wrap;margin:10px 0 18px}
  .filters input,.filters select{padding:10px 12px;border:1px solid var(--border);border-radius:10px;background:#fff}
  .grid{display:grid;gap:12px}
  @media(min-width:860px){.grid{grid-template-columns:repeat(3,1fr)}}
  .card{background:#fff;border:1px solid var(--border);border-radius:14px;padding:14px}
  .title{font-weight:700;margin:0 0 4px}
  .meta{font-size:13px;color:var(--muted);margin:2px 0 8px}
  .tag{display:inline-block;background:#eef2ff;border:1px solid #c7d2fe;padding:2px 8px;border-radius:999px;font-size:12px;margin-right:6px}
  .empty{color:var(--muted);padding:20px;border:1px dashed var(--border);border-radius:12px;background:#fff}
  .topbar{display:flex;justify-content:space-between;gap:10px;align-items:center}
  a{color:var(--brand);text-decoration:none}
  a:hover{text-decoration:underline}
  .note{color:var(--muted);font-size:13px;margin-top:8px}
</style>
</head>
<body>

<!-- HEADER DINAMIS -->
<div id="site-header"></div>
<script>
  // muat header.html sekali untuk semua halaman
  fetch("header.html", {cache:"no-store"})
    .then(r=>r.text())
    .then(html=>{
      document.getElementById("site-header").outerHTML = html;
    })
    .catch(e=>console.error("Gagal load header:", e));
</script>

<!-- KONTEN HALAMAN -->
<div class="wrap">
  <div class="topbar">
    <div>
      <h1>Research Lifecycle Tracker</h1>
      <p class="sub">Klik fase di bawah untuk melihat pekerjaan tiap mahasiswa. Sumber data: Google Sheets (CSV export).</p>
    </div>
    <div><a href="images/RLM_TKD.png" target="_blank">Lihat Diagram RLM</a></div>
  </div>

  <!-- Phases -->
  <div class="rlm" id="phases">
    <button class="phase" data-phase="Plan">Plan</button>
    <button class="phase" data-phase="Execute">Execute</button>
    <button class="phase" data-phase="Process">Process</button>
    <button class="phase" data-phase="Report">Report</button>
    <button class="phase" data-phase="Disseminate">Disseminate</button>
    <button class="phase" data-phase="Preserve">Preserve</button>
  </div>

  <!-- Filters -->
  <div class="filters">
    <input type="search" id="q" placeholder="Cari nama/judul/pekerjaan…" />
    <select id="advisor"><option value="">Pembimbing (semua)</option></select>
    <select id="program">
      <option value="">Program (semua)</option>
      <option>S1 Teknik Perkapalan</option><option>S2 Teknik Perkapalan</option><option>S3 Teknik Perkapalan</option>
    </select>
  </div>

  <div class="grid" id="list"></div>
  <p class="note">Tips: Isi via Google Form → masuk ke Sheet → tampil di sini (tergantung cache beberapa detik).</p>
</div>

<script>
// === KONFIGURASI ===
const CSV_URL = "https://docs.google.com/spreadsheets/d/1Os0hRdXtAc4A_3ndDx2P7ImBoii8n58BUH_HNsfZXkk/export?format=csv&gid=628575131";

// === UTIL CSV PARSER (ringan) ===
function parseCSV(text){
  const rows = [];
  let cur = '', row = [], inQuotes = false;
  for (let i=0;i<text.length;i++){
    const c = text[i], n = text[i+1];
    if (inQuotes){
      if (c === '"' && n === '"'){ cur += '"'; i++; }
      else if (c === '"'){ inQuotes = false; }
      else cur += c;
    } else {
      if (c === '"') inQuotes = true;
      else if (c === ','){ row.push(cur); cur=''; }
      else if (c === '\n'){ row.push(cur); rows.push(row); row=[]; cur=''; }
      else cur += c;
    }
  }
  if (cur.length || row.length) { row.push(cur); rows.push(row); }
  return rows.map(r => r.map(c => (c||'').trim()));
}

// === STATE ===
let ALL = [];
let currentPhase = "Plan";

// === DOM HOOKS ===
const phasesEl = document.getElementById('phases');
const listEl   = document.getElementById('list');
const qEl      = document.getElementById('q');
const advEl    = document.getElementById('advisor');
const progEl   = document.getElementById('program');

// === DATA MAPPING (toleran) ===
function rowToObj(header, r){
  const H = header.map(h => (h||'').toString().trim().toLowerCase());
  const ix = name => H.indexOf(name.toLowerCase());
  return {
    Nama:        r[ix('nama mahasiswa')]           || '',
    Judul:       r[ix('judul riset')]              || '',
    Fase:       (r[ix('fase riset')]               || '').replace(/\s+/g,' ').trim(),
    Pembimbing:  r[ix('dosen pembimbing')]         || '',
    Program:     r[ix('program studi')]            || '',
    Pekerjaan:   r[ix('update pekerjaan')]         || '',
    LinkedIn:    r[ix('linkedin url')]             || '',
    Progress:    r[ix('progress (%)')]             || '',
    Tanggal:     r[ix('tanggal update')]           || '',
    LinkDokumen: r[ix('link dokumen/laporan')]     || '',
    LinkDataset: r[ix('link dataset')]             || '',
    LinkCode:    r[ix('link repositori kode')]     || ''
  };
}

// === RENDER ===
function render(){
  [...phasesEl.querySelectorAll('.phase')].forEach(b=>{
    b.classList.toggle('active', b.dataset.phase===currentPhase);
  });

  const q = (qEl.value||'').toLowerCase();
  const adv = advEl.value;
  const prog = progEl.value;

  const filtered = ALL.filter(x =>
    (x.Fase===currentPhase) &&
    (!q   || (x.Nama + ' ' + x.Judul + ' ' + x.Pekerjaan).toLowerCase().includes(q)) &&
    (!adv || x.Pembimbing===adv) &&
    (!prog|| x.Program===prog)
  );

  if (!filtered.length){
    listEl.innerHTML = `<div class="empty">Belum ada entri untuk fase <b>${currentPhase}</b>.</div>`;
    return;
  }

  listEl.innerHTML = filtered.map(x => `
    <div class="card">
      <div class="title">${x.Nama}${x.LinkedIn ? ` — <a href="${x.LinkedIn}" target="_blank" rel="noopener">LinkedIn</a>` : ''}</div>
      <div class="meta">
        <span class="tag">${x.Program || '-'}</span>
        <span class="tag">${x.Pembimbing || '-'}</span>
        <span class="tag">${x.Progress ? (x.Progress+'%') : 'Progress -'}</span>
        <span class="tag">${x.Tanggal || '-'}</span>
      </div>
      <div class="meta"><b>Judul:</b> ${x.Judul || '-'}</div>
      <div><b>Pekerjaan:</b> ${x.Pekerjaan || '-'}</div>
      ${x.LinkDokumen||x.LinkDataset||x.LinkCode ? `
        <div class="meta">
          ${x.LinkDokumen ? `<a href="${x.LinkDokumen}" target="_blank">Dokumen</a> · `:''}
          ${x.LinkDataset ? `<a href="${x.LinkDataset}" target="_blank">Dataset</a> · `:''}
          ${x.LinkCode ? `<a href="${x.LinkCode}" target="_blank">Kode</a>`:''}
        </div>` : ``}
    </div>
  `).join('');
}

// === LOAD CSV ===
async function loadCSV(){
  const res = await fetch(CSV_URL, {cache:'no-store'});
  let text = await res.text();
  text = text.replace(/\r/g,'').trim(); // normalisasi CRLF
  const rows = parseCSV(text).filter(r => r.some(c => (c||'').trim() !== ''));
  const header = rows.shift() || [];
  ALL = rows.map(r => rowToObj(header, r)).filter(x => x.Nama || x.Judul);

  const advisors = [...new Set(ALL.map(x=>x.Pembimbing).filter(Boolean))].sort();
  advEl.innerHTML = `<option value="">Pembimbing (semua)</option>` + advisors.map(a=>`<option>${a}</option>`).join('');
  render();
}

// === EVENTS ===
phasesEl.addEventListener('click', e=>{
  const b = e.target.closest('.phase'); if(!b) return;
  currentPhase = b.dataset.phase; render();
});
[qEl, advEl, progEl].forEach(el=>el.addEventListener('input', render));

// === INIT ===
loadCSV().catch(err=>{
  listEl.innerHTML = `<div class="empty">Gagal memuat data. Cek URL CSV & izin akses Sheet (Anyone with the link, Viewer).</div>`;
  console.error(err);
});
</script>
</body>
</html>
